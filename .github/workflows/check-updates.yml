name: Lang Monitor - ç¿»è¯‘æ–‡ä»¶æ›´æ–°æ£€æŸ¥

on:
  # å®šæ—¶è¿è¡Œ - æ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  schedule:
    - cron: '0 */6 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_notify:
        description: 'å¼ºåˆ¶å‘é€é€šçŸ¥ï¼ˆå³ä½¿æ— æ›´æ–°ï¼‰'
        required: false
        default: false
        type: boolean

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥æäº¤çŠ¶æ€æ–‡ä»¶

jobs:
  check-updates:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨PATä»¥ä¾¿èƒ½å¤Ÿæ¨é€æ›´æ”¹
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ” è¿è¡Œæ›´æ–°æ£€æŸ¥
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          python scripts/check_updates.py
      
      - name: ğŸ’¾ æäº¤çŠ¶æ€æ›´æ–°
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet data/state.json; then
            echo "ğŸ“ çŠ¶æ€æ–‡ä»¶æ— å˜æ›´"
          else
            git add data/state.json
            git commit -m "ğŸ”„ æ›´æ–°ç›‘æ§çŠ¶æ€ [skip ci]"
            git push
            echo "âœ… çŠ¶æ€æ–‡ä»¶å·²æ›´æ–°å¹¶æ¨é€"
          fi
      
      - name: ğŸ“Š è¾“å‡ºæ£€æŸ¥ç»“æœ
        if: always()
        run: |
          echo "æ£€æŸ¥å®Œæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "æ›´æ–°æ•°é‡: ${{ steps.check.outputs.update_count || '0' }}"
