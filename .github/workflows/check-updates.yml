name: Lang Monitor - ç¿»è¯‘æ–‡ä»¶æ›´æ–°æ£€æŸ¥

on:
  # å®šæ—¶è¿è¡Œ - æ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  schedule:
    - cron: '0 */6 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reset_state:
        description: 'é‡ç½®çŠ¶æ€ï¼ˆæ¸…é™¤å†å²è®°å½•ï¼Œé‡æ–°å¼€å§‹ç›‘æ§ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  check-updates:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v6.0.1
      
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ æ¢å¤çŠ¶æ€ç¼“å­˜
        if: ${{ github.event.inputs.reset_state != 'true' }}
        id: cache-state
        uses: actions/cache@v5.0.1
        with:
          path: data/state.json
          key: monitor-state-${{ github.run_id }}
          restore-keys: |
            monitor-state-
      
      - name: ğŸ” è¿è¡Œæ›´æ–°æ£€æŸ¥
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          python scripts/check_updates.py
      
      - name: ğŸ’¾ ä¿å­˜çŠ¶æ€ç¼“å­˜
        uses: actions/cache/save@v5.0.1
        if: always()
        with:
          path: data/state.json
          key: monitor-state-${{ github.run_id }}
      
      - name: ğŸ“Š è¾“å‡ºæ£€æŸ¥ç»“æœ
        if: always()
        run: |
          echo "æ£€æŸ¥å®Œæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "æ›´æ–°æ•°é‡: ${{ steps.check.outputs.update_count || '0' }}"
